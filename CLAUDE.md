# RIPER-5 工作流规则

## 核心原则

本项目采用 RIPER-5 工作流，强制"调研优先，编码在后"。

## 模式声明要求

每次回复必须在开头声明当前模式：
- `[MODE: RESEARCH]` - 调研阶段
- `[MODE: INNOVATE]` - 方案探索阶段
- `[MODE: PLAN]` - 规划阶段
- `[MODE: EXECUTE]` - 执行阶段
- `[MODE: REVIEW]` - 审查阶段

## 自动阶段判断规则

### 进入 RESEARCH 模式的条件（自动）
当用户消息符合以下任一条件时，必须先进入 RESEARCH 模式：
- 描述新功能需求（"实现"、"添加"、"创建" + 功能描述）
- 报告复杂 bug（"修复"、"解决" + 非显而易见的问题）
- 请求重构（"重构"、"优化"、"改进" + 模块/功能）
- 涉及你不熟悉的代码区域
- 涉及多个文件的修改
- 技术选型决策

### 跳过 RESEARCH 的条件（直接执行）
- 用户明确说"直接改"、"简单修复"、"快速"
- 任务明显简单（改配置、修 typo、调样式）
- 用户已提供完整实现方案
- 单文件 10 行以内的修改

## RESEARCH 模式行为规范

在 RESEARCH 模式下：

### 1. 需求澄清（第一步）

在开始调研前，先检查需求是否清晰。如果存在以下不确定性，**必须先使用 AskUserQuestion 工具询问**：

- 功能的边界和范围不明确
- 存在多种技术路线可选
- 涉及用户偏好（UI风格、库选择等）
- 存在潜在的兼容性要求
- 性能/安全有特殊要求

**澄清问题示例**：
- "这个功能需要支持哪些边界情况？"
- "你更倾向于使用现有库还是自己实现？"
- "需要兼容哪些浏览器/环境？"

**如果需求已经清晰**，跳过澄清，直接进入调研。

### 2. 执行调研

根据任务类型选择调研方式：

| 调研类型 | 触发条件 | 工具 |
|----------|----------|------|
| 代码库分析 | 涉及现有代码 | Read, Grep, Glob |
| GitHub 调研 | 需要找开源方案 | `gh search repos`, WebFetch |
| 最佳实践 | 技术选型决策 | WebSearch, context7 |

### 3. 保存调研结果

- 所有调研报告保存到 `.claude/memory-bank/research/` 对应子目录
- 文件名格式：`{task-slug}-{date}.md`

### 4. 报告并等待确认

- 展示调研摘要（不超过 10 点关键发现）
- 明确询问："调研完成。是否进入规划阶段？还是需要补充调研？"

### 5. 禁止行为

- ❌ 不要写任何实现代码
- ❌ 不要做技术决策（只提供建议）
- ❌ 不要创建/修改源代码文件

## PLAN 模式行为规范

进入条件：用户确认调研完成，同意进入规划

1. **读取调研报告**
   - 从 `.claude/memory-bank/research/` 读取相关报告

2. **创建实施计划**
   - 保存到 `.claude/memory-bank/plans/{task-slug}.md`
   - 计划必须包含：目标、步骤清单、影响文件、测试计划、风险

3. **等待批准**
   - 展示计划摘要
   - 询问："计划已制定。是否批准执行？"
   - 计划文件首行标记 `STATUS: PENDING`
   - 用户批准后改为 `STATUS: APPROVED`

## EXECUTE 模式行为规范

进入条件：存在 `STATUS: APPROVED` 的计划文件

### 核心心态：林纳斯模式

> **目标：在最短时间内做出可运行的版本，而不是完美的产品。**

遵循以下原则：
- **KISS** - Keep It Simple, Stupid（保持简单）
- **YAGNI** - You Aren't Gonna Need It（不做过度设计）
- **DRY** - Don't Repeat Yourself（避免重复）
- **SOLID** - 单一职责、开闭原则等

### 执行要求

1. **严格按 PRD/MVP 实现**
   - 只做被要求的功能，不做"顺便优化"
   - 以「能跑起来」为第一目标
   - 有不清楚的地方立即提问确认

2. **严格按计划执行**
   - 每完成一步，更新计划中的 checkbox
   - 如需偏离计划，立即停止，返回 PLAN 模式

3. **分步骤生成代码**
   - 不要一次性生成所有代码
   - 每步完成后验证再继续

4. **持续验证**
   - 每个逻辑单元完成后运行相关测试
   - 发现问题立即报告

### 禁止行为

- ❌ 过度工程化（不需要的抽象层）
- ❌ 提前优化（先跑起来再说）
- ❌ 添加计划外的功能
- ❌ 未经确认的技术决策

## REVIEW 模式行为规范

执行完成后自动进入：

1. **对比检查**
   - 实现 vs 计划：是否有偏差？
   - 测试覆盖：是否充分？

2. **生成报告**
   - 保存到 `.claude/memory-bank/reviews/{task-slug}.md`

## Memory Bank 约定

| 目录 | 用途 | 保留时长 |
|------|------|---------|
| `research/github/` | GitHub 项目调研 | 永久 |
| `research/codebase/` | 代码库分析 | 永久 |
| `research/best-practices/` | 最佳实践 | 永久 |
| `research/competitors/` | 竞品分析 | 永久 |
| `plans/` | 实施计划 | 任务完成后可归档 |
| `reviews/` | 审查记录 | 永久 |

## 自动触发 Skills

以下 Skills 会根据任务类型自动触发，无需手动输入：

| Skill | 触发条件 |
|-------|----------|
| `research-first` | 新功能、复杂bug、重构、多文件修改 |
| `workflow-guide` | 开始新任务、问工作流程、需要确定阶段 |
| `github-search` | 需要搜索开源项目、找轮子 |

## 手动命令（备选）

当自动触发失效或需要强制进入某阶段时使用：

| 命令 | 用途 |
|------|------|
| `/quick-impl <描述>` | 快速实现（调研→实现） |
| `/dev-flow <描述>` | 完整工作流（规划→调研→实现→审查） |

## 项目特定约定

<!-- 在此添加项目特定的编码规范、目录约定等 -->

## 掌天瓶 (Orchestrate)

本项目支持异构多代理掌天瓶。代理注册表见 `AGENTS.md`。
- **每次对话开始时**：读取 `.orchestrator/state/mode.txt`，在首次回复开头告知用户当前模式（如 `[掌天瓶: OFF]` 或 `[掌天瓶: ON]`）
- 启用掌天瓶：说"启用掌天瓶"或"orchestrate on"
- 关闭掌天瓶：说"关闭掌天瓶"或"orchestrate off"
- 紧急退出：`touch /tmp/FORCE_STOP`
- 当前状态：`.orchestrator/state/mode.txt`（on/off）
